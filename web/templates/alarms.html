<!-- web/templates/alarms.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>GroupAlarm – Alarme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet von CDN (funktioniert in der Regel via Ingress) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font: 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header {
      display:flex; gap:.5rem; align-items:center; padding: .75rem 1rem;
      border-bottom: 1px solid rgba(0,0,0,.1);
      position: sticky; top: 0; background: var(--ha-card-background, #fff); z-index: 10;
    }
    header a { text-decoration: none; color: inherit; padding: .4rem .6rem; border-radius: .5rem; }
    header a.active { background: rgba(0,0,0,.06); }
    .page { padding: 1rem; max-width: 1100px; margin: 0 auto; }
    .alarm {
      border: 1px solid rgba(0,0,0,.1); border-radius: 14px; padding: .9rem; margin: .8rem 0;
      background: var(--ha-card-background, #fff); box-shadow: 0 1px 6px rgba(0,0,0,.05);
    }
    .row { display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .sev-dot {
      width: .8rem; height: .8rem; border-radius: 50%;
      border: 1px solid rgba(0,0,0,.15);
    }
    .org { font-weight: 600; }
    .msg { margin-top: .25rem; font-size: 0.95rem; }
    .meta { opacity: .75; font-size: .85rem; margin-top: .25rem; }
    .map {
      height: 220px; border-radius: 12px; margin-top: .75rem; overflow: hidden; border: 1px solid rgba(0,0,0,.08);
    }
    .empty { opacity: .6; padding: 2rem 1rem; text-align: center; }
  </style>

  <script>
    // Simple Auto-Reload alle 5 Sekunden
    setInterval(() => {
      // leichter: komplette Seite neu laden
      location.reload();
    }, 5000);
  </script>
</head>
<body>
<header>
  <a href="{{ url_for('index') }}" class="{{ 'active' if active_tab=='dashboard' else '' }}">Dashboard</a>
  <a href="{{ url_for('alarms_page') }}" class="{{ 'active' if active_tab=='alarms' else '' }}">Alarme</a>
</header>

<div class="page">
  {% if not alarms or alarms|length == 0 %}
    <div class="empty">Zur Zeit liegen keine Alarme vor.</div>
  {% else %}
    {% for a in alarms %}
      <div class="alarm">
        <div class="row">
          <div class="sev-dot" style="background: {{ a.sev_color | e }};"></div>
          <div class="org">{{ a.org_name }}</div>
          {% if a.event_name %}
            <div>•</div>
            <div>{{ a.event_name }}</div>
          {% endif %}
        </div>
        {% if a.message %}
          <div class="msg">{{ a.message }}</div>
        {% endif %}
        <div class="meta">
          Alarm #{{ a.id }} • Start: {{ a.startDate or '–' }}
        </div>

        {% if a.lat is not none and a.lon is not none %}
          <div id="map-{{ a.id }}" class="map"></div>
          <script>
            (function(){
              const lat = {{ a.lat }};
              const lon = {{ a.lon }};
              const map = L.map("map-{{ a.id }}").setView([lat, lon], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
              }).addTo(map);
              L.marker([lat, lon]).addTo(map);
            })();
          </script>
        {% endif %}
      </div>
    {% endfor %}
  {% endif %}
</div>
</body>
</html>
